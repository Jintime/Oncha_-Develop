<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="/css/order/payInfo.css" rel="stylesheet">
</head>
<body>
<header>
  <div class="nav_barContainer">
    <div class="left"><a class="index_bt" href="/"><img class="top_logo" src="/img/Logo.png"></a>
      <button class="myoncha_bt">마이온차</button>
      <button class="store_bt">스토어</button>
      <button class="teaHouse_bt">티하우스</button>
      <button class="subscribe_bt">커뮤니티</button>

    </div>
    <div class="right">
      <input class="search" type="text" >
      <button th:if="${user == null}" class="login_bt">로그인</button>
      <a th:unless="${user==null}" th:href="@{/mypage/{id}(id =${user.id})}">
        <!--<img th:src="@{|${user.list.get(0).getUrl()}|}" alt="">-->마이페이지</a>
    </div>
  </div>
  </div>
</header>
<main>
  <h1>결제하기</h1>
  <div class="pay_info_wrap">
    <div class="order_detail_wrap">
      <div class="product_info">
        <h3>주문상품정보</h3>
        <div class="product_detail">
          <img th:src="${product.list.get(0).url}" src="img/프로덕트칸.png">
          <div class="info">
            <p th:text="${product.title}">타이틀 테스트입니다</p>
            <p><a>옵션</a>없음 0개</p>
            <p th:text="${product.price}">1,000원</p>
          </div>
          <button>배송비 3,000원</button>
        </div>
      </div>

      <div class="buyer_info">
        <h3>주문자 정보</h3>
        <div th:if="${user==null}" class="buyer_detail">
          <input class="buyer_other" name="buyerName" type="text" placeholder="이름">
          <input class="buyer_other" name="phoneNumber" type="text" placeholder="연락처">
          <input class="buyer_email" name="email" type="text" placeholder="이메일">
          <input class="buyer_other" name="password" type="text" placeholder="주문 비밀번호">
          <input class="buyer_other" name="passwordCheck" type="text" placeholder="주문 비밀번호 확인">
        </div>
        <div th:unless="${user==null}" class="buyer_detail">
          <input class="buyer_other" name="buyerName" type="text"  th:value="${user.name}">
          <input class="buyer_other" name="phoneNumber" type="text" placeholder="휴대폰번호" th:value="${user.phoneNumber}">
          <input class="buyer_email" name="email" type="text" th:value="${user.email}">
        </div>

        </div>


      <div class="delivery_info">
        <h3>배송정보</h3>
        <div class="delivery_detail">
          <input type="checkbox"> 주문자 정보와 동일<br>
          <input class="buyer_other" name="userName" type="text" placeholder="수령인">
          <input class="buyer_other" name="phoneNumber" type="text" placeholder="연락처"><br>
          <label for="zip">주소 :</label>
          <input name="zip" type="text" id="zip" style="width:200px; height:50px;" placeholder="우편번호" />
          <button id= "postcodebutton" type="button" style="width:60px; height:50px;">주소찾기</button><br>
          <input name="address1" type="text" id="address1" style="width:270px; height:50px;" readonly placeholder="주소"/><br>
          <input name="address2" type="text" id="address2" style="width:270px; height:50px;" placeholder="상세" />
          <h4>배송메모</h4>
          <input type="text" placeholder="배송메모를 선택해주세요">
        </div>
      </div>
    </div>


    <div class="pay_detail_wrap">

      <div class="pay_detail">
        <h3>결제 상세</h3>
        <div class="pay_info">
          <div class="info_left">
            <p>상품가격</p>
            <p>배송비</p>
            <p>할인</p>
            <hr>
            <p>총 주문금액</p>
          </div>
          <div class="info_right">
            <p>10,000원</p>
            <p>무료</p>
            <p>없음</p>
            <hr>
            <p> 00000 원</p>
          </div>
        </div>

      </div>



      <div class="pay_type_wrap">
        <h3>결제수단</h3>
        <div class="pay_type_detail">
          <fieldset>
            <input id="creditCard" type="checkbox" value="신용카드">
            <label for="creditCard">신용카드</label>

            <input id="virtualAccount" type="checkbox" value="가상계좌">
            <label for="virtualAccount">가상계좌</label>

            <input id="bank" type="checkbox" value="무통장입금">
            <label for="bank">무통장입금</label>

            <input id="kakaoPay" type="checkbox" value="카카오페이">
            <label for="kakaoPay">카카오페이</label>

            <input id="payco" type="checkbox" value="PAYCO">
            <label for="payco">페이코</label>

            <input id="samsungPay" type="checkbox" value="삼성페이">
            <label for="samsungPay">상성페이</label>

            <input id="phonePay" type="checkbox" value="휴대폰">
            <label for="phonePay">휴대폰</label>
          </fieldset>
        </div>
      </div>

      <div class="agree_wrap">
        <div class="agree_detail">
          <fieldset>
            <input id="assent" type="checkbox" value="true">
            <label for="assent">전체동의 </label><br>
            <input id="privacy" type="checkbox" value="true">
            <label for="privacy">개인정보 수집 및 이용동의</label><a> 약관보기</a><br>
            <input id="payAssent" type="checkbox" value="true">
            <label for="payAssent">구매조건 확인 및 결제 진행에 동의</label><br>
          </fieldset>
          <button  onclick="iamport()">결제하기</button>
        </div>
      </div>

    </div>

  </div>
</div>
</main>
<footer>
  <div id="coinfo_container">
    <div class="coinfoinner">
      <img src="/img/Logo.png">
      <p>E-mail : oncha.minji@gmail.com</p>
      <p>Copyright 2023 Oncha</p>
    </div>
  </div>
</footer>
</body>
<script>
  function iamport() {
    const currentURL = window.location.href;
    const pattern = /\d+$/;
    const match = currentURL.match(pattern);
    const lastNumber = match ? match[0] : '';

    $.ajax({
      type: "POST",
      url: `/request_pay/`+lastNumber,
      success: function (res) {
        IMP.init("imp85443833");
        IMP.request_pay({
          pg: 'kcp.A52CY',
          pay_method: 'card',
          merchant_uid: 'merchant_' + new Date().getTime(),
          name: res.product_name,
          amount: "100",
          buyer_email:res.buyer_email,
          buyer_name: res.buyer_name,
          buyer_tel: res.buyer_tel,
          buyer_postcode: "우편번호다~",
          m_redirect_url: 'http://localhost:8080/orderComplete'
        }, function (res) {
          // 결제검증
          console.log(res);
          $.ajax({
            type: "POST",
            url: "/verifyIamport/" + res.imp_uid
          }).done(function (data) {
            console.log(data);
            if (res.paid_amount == data.response.amount) {
              alert("결제 및 결제검증완료");

              //결제 성공 시 비즈니스 로직

            } else {
              alert("결제 실패");
            }
          });
        });
      }
    });
  }

</script>
<script src="/js/buttonManager.js"></script>
<script type="module" src="/js/registry.js"></script>
</html>